generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -----------------------------------------------------------------------------
// AUTH & USER MODELS
// -----------------------------------------------------------------------------

enum UserRole {
  ADMIN
  ACCOUNTANT
  STAFF
  EMPLOYEE
  CLIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String         @id @default(cuid())
  firstName     String?
  lastName      String?
  name          String?
  email         String?        @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          UserRole       @default(STAFF)
  status        UserStatus     @default(ACTIVE)
  companyId     String?
  company       ClientCompany? @relation(fields: [companyId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  accounts Account[]
  sessions Session[]

  // CRM Relations
  assignedRequests ServiceRequest[] @relation("AssignedTo")
  assignedTasks    Task[]           @relation("AssignedTo")
  assignedLeads    Lead[]           @relation("LeadAssignee")
  uploadedDocs     Document[]
  activities       ActivityLog[]
  notifications    Notification[]
  // v1.0 Tenancy
  workspaceId      String?
  workspace        Workspace?       @relation(fields: [workspaceId], references: [id])
  analyticsEvents  AnalyticsEvent[]
}

model Workspace {
  id        String   @id @default(cuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  leads       Lead[]
  campaigns   Campaign[]
  templates   EmailTemplate[]
  domains     SendingDomain[]
  mailboxes   SendingMailbox[]
  profiles    SendingProfile[]
  jobs        EmailJob[]
  messages    EmailMessage[]
  events      EmailEvent[]
  stages      PipelineStage[]
  enrollments CampaignEnrollment[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// -----------------------------------------------------------------------------
// CRM MODELS
// -----------------------------------------------------------------------------

model ClientCompany {
  id                 String   @id @default(cuid())
  legalName          String
  tradingName        String?
  registrationNumber String?  @unique // CIPC
  vatNumber          String?
  payeNumber         String?
  uifNumber          String?
  sdlNumber          String?
  industry           String?
  address            String?
  city               String?
  province           String?
  country            String   @default("ZA")
  primaryContactId   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  contacts        ClientContact[]
  serviceRequests ServiceRequest[]
  documents       Document[]
  activities      ActivityLog[]
  xeroConnection  XeroConnection?
  emailEvents     EmailEvent[]
  users           User[]
}

model ClientContact {
  id        String   @id @default(cuid())
  companyId String
  fullName  String
  email     String
  phone     String?
  roleTitle String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company ClientCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

enum ServiceType {
  Bookkeeping
  Accounting
  Tax
  Advisory
  CIPC
  CompaniesAct
  Payroll
  AuditReadiness
  TenderReadiness
  DataAnalytics
  BusinessIT
  ShelfCompany
  Compliance
  Registration
  Trusts
  Other
}

enum RequestStatus {
  New
  InProgress
  AwaitingDocs
  Submitted
  Completed
  Archived
}

enum Priority {
  Low
  Med
  High
}

model ServiceRequest {
  id               String        @id @default(cuid())
  companyId        String
  serviceType      ServiceType
  status           RequestStatus @default(New)
  priority         Priority      @default(Med)
  description      String?       @db.Text
  startDate        DateTime?
  dueDate          DateTime?
  assignedToUserId String?

  // Link to Lead
  leadId String?
  lead   Lead?   @relation(fields: [leadId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     ClientCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedTo  User?         @relation("AssignedTo", fields: [assignedToUserId], references: [id])
  tasks       Task[]
  documents       Document[]
  activities      ActivityLog[]
  emailEvents     EmailEvent[]
  analyticsEvents AnalyticsEvent[]
  notifications   Notification[]
}

enum TaskStatus {
  Open
  Done
}

enum TaskType {
  FollowUp
  DocumentRequest
  Deadline
  InternalReview
}

model Task {
  id               String     @id @default(cuid())
  serviceRequestId String
  title            String
  description      String?    @db.Text
  status           TaskStatus @default(Open)
  dueDate          DateTime?
  assignedToUserId String?
  type             TaskType   @default(InternalReview)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  assignedTo     User?          @relation("AssignedTo", fields: [assignedToUserId], references: [id])
}

enum DocType {
  ID
  BankStatement
  Invoice
  CIPC
  SARS
  TenderDoc
  Other
}

enum AccessLevel {
  InternalOnly
  ClientVisible
}

model Document {
  id               String      @id @default(cuid())
  companyId        String
  serviceRequestId String?
  type             DocType     @default(Other)
  filename         String
  storageKey       String
  mimeType         String?
  size             Int?
  uploadedByUserId String
  uploadedAt       DateTime    @default(now())
  accessLevel      AccessLevel @default(InternalOnly)

  company        ClientCompany   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  uploadedBy     User            @relation(fields: [uploadedByUserId], references: [id])
}

model ActivityLog {
  id               String   @id @default(cuid())
  actorUserId      String
  companyId        String?
  serviceRequestId String?
  actionType       String
  actionSummary    String
  metadata         Json?
  createdAt        DateTime @default(now())

  actor          User            @relation(fields: [actorUserId], references: [id])
  company        ClientCompany?  @relation(fields: [companyId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ALERT
}

enum NotificationSeverity {
  INFO
  SUCCESS
  WARNING
  CRITICAL
}

model Notification {
  id        String               @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType     @default(INFO) // Keeping for backward compat, mapped to severity
  severity  NotificationSeverity @default(INFO)
  category  String               @default("SYSTEM") // E.g., Lead, Request, Invoice
  
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())
  
  metadata  Json?
  
  relatedLeadId String?
  relatedLead   Lead? @relation(fields: [relatedLeadId], references: [id])
  
  relatedRequestId String?
  relatedRequest   ServiceRequest? @relation(fields: [relatedRequestId], references: [id])

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum EmailType {
  LeadReceived
  ClientConfirmation
  DocsRequested
  Reminder
  StatusUpdate
}

model EmailEvent {
  id                      String    @id @default(cuid())
  type                    EmailType
  to                      String
  subject                 String
  status                  String // Sent, Failed, etc.
  providerMessageId       String?
  relatedCompanyId        String?
  relatedServiceRequestId String?
  createdAt               DateTime  @default(now())

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  company        ClientCompany?  @relation(fields: [relatedCompanyId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [relatedServiceRequestId], references: [id])

  emailMessageId String?
  emailMessage   EmailMessage? @relation(fields: [emailMessageId], references: [id])
}

// -----------------------------------------------------------------------------
// LEADS MODELS
// -----------------------------------------------------------------------------

enum LeadSource {
  Website
  Manual
  WhatsApp
  Referral
  EmailImport
}

enum BusinessType {
  SME
  Corporate
  Startup
  Other
}

enum VatStatus {
  Registered
  NotRegistered
  Unknown
}

enum AwarenessStage {
  Unaware
  ProblemAware
  SolutionAware
  ServiceAware
  Ready
}

enum LeadLocation {
  Johannesburg
  Sandton
  Pretoria
  Other
}

enum LeadUrgency {
  Urgent_24_48h
  Soon_7d
  Flexible_30d
}

enum LeadBudgetRange {
  Unknown
  Under5k
  R5k_15k
  R15k_30k
  R30kPlus
}

enum LeadStatus {
  Incomplete
  New
  InReview
  AwaitingDocs
  Quoted
  Converted
  Archived
}

model Lead {
  id               String          @id @default(cuid())
  referenceId      String          @unique
  firstName        String
  lastName         String
  fullName         String? // Deprecated
  email            String
  phone            String
  companyName      String?
  websiteUrl       String?
  source           LeadSource      @default(Website)
  serviceType      ServiceType
  location         LeadLocation    @default(Other)
  freeTextLocation String?
  urgency          LeadUrgency     @default(Soon_7d)
  budgetRange      LeadBudgetRange @default(Unknown)
  message          String?         @db.Text
  status           LeadStatus      @default(New)
  leadScore        Int             @default(0)
  priorityTag      Priority        @default(Med)
  assignedToUserId String?
  assignedToUser   User?           @relation("LeadAssignee", fields: [assignedToUserId], references: [id])
  lastContactedAt  DateTime?
  nextFollowUpAt   DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  // Onboarding Tracking
  lastStepCompleted Int       @default(0)
  abandonedAt       DateTime?
  resumeToken       String?   @unique
  deviceMetadata    Json?
  metadata          Json?

  // Outreach & Scoring (v1.0)
  businessType   BusinessType   @default(Other)
  vatStatus      VatStatus      @default(Unknown)
  awarenessStage AwarenessStage @default(Unaware)

  pipelineStageId String?
  pipelineStage   PipelineStage? @relation(fields: [pipelineStageId], references: [id])
  ownerUserId     String?

  personaType     String? // Enum?
  domainRiskScore Int     @default(0)

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  // Relations
  requests    ServiceRequest[] // Converted requests
  enrollments CampaignEnrollment[]
  campaigns   CampaignLead[] // Deprecated or keep for legacy compatibility
  jobs        EmailJob[]
  persona     LeadPersona?

  // existing
  documents    LeadDocument[]
  statusEvents LeadStatusEvent[]
  portalTokens LeadPortalToken[]

  // legacy relations
  outreachEvents  OutreachEvent[]
  analyticsEvents AnalyticsEvent[]
  notifications   Notification[]
}

model LeadPersona {
  id            String  @id @default(cuid())
  leadId        String  @unique
  personaType   String
  mainPainPoint String?
  urgencyLevel  String?
  advisoryAngle String?

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

enum LeadDocType {
  ID
  BankStatement
  ProofOfAddress
  CompanyDocs
  TaxDocs
  Other
}

enum LeadDocumentUploadedBy {
  Client
  Staff
}

model LeadDocument {
  id         String                 @id @default(cuid())
  leadId     String
  filename   String
  storageKey String
  mimeType   String?
  size       Int?
  type       LeadDocType            @default(Other)
  uploadedBy LeadDocumentUploadedBy @default(Client)
  uploadedAt DateTime               @default(now())
  note       String?                @db.Text

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model LeadStatusEvent {
  id          String     @id @default(cuid())
  leadId      String
  oldStatus   LeadStatus
  newStatus   LeadStatus
  actorUserId String?
  createdAt   DateTime   @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model LeadPortalToken {
  id        String   @id @default(cuid())
  leadId    String
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  lead Lead @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Invite {
  id        String   @id @default(cuid())
  email     String   @unique
  token     String   @unique
  role      UserRole
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  expires   DateTime
  invitedBy String?
  createdAt DateTime @default(now())
}

// -----------------------------------------------------------------------------
// XERO INTEGRATION MODELS
// -----------------------------------------------------------------------------

enum XeroConnectionStatus {
  Connected
  Revoked
  Error
}

model XeroConnection {
  id           String               @id @default(cuid())
  companyId    String               @unique
  tenantId     String
  accessToken  String               @db.Text // Encrypted
  refreshToken String               @db.Text // Encrypted
  expiresAt    DateTime
  scopes       String?
  status       XeroConnectionStatus @default(Connected)
  lastSyncAt   DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  company     ClientCompany    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncCursors XeroSyncCursor[]
}

model XeroSyncCursor {
  id               String   @id @default(cuid())
  xeroConnectionId String
  resourceType     String // Contacts, Invoices, Payments, BankTransactions
  lastSyncedAt     DateTime @default(now())
  lastCursor       String?

  connection XeroConnection @relation(fields: [xeroConnectionId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id           String   @id @default(cuid())
  key          String   @unique
  subject      String?
  preheader    String?
  body         Json? // Stores structured content or overrides
  lastEditedBy String? // User ID or name
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspaceId String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id])

  steps CampaignStep[]
  jobs  EmailJob[]
}

// -----------------------------------------------------------------------------
// OUTREACH SYSTEM v1.0 MODELS
// -----------------------------------------------------------------------------

// --- A4: Enrollment ---

enum EnrollmentStatus {
  Enrolled
  Active
  Paused
  Completed
  Exited
  Suppressed
}

enum ExitReason {
  Replied
  BookedMeeting
  Unsubscribed
  Bounced
  Manual
  Other
}

model CampaignEnrollment {
  id                String           @id @default(cuid())
  workspaceId       String
  campaignId        String
  leadId            String
  status            EnrollmentStatus @default(Enrolled)
  currentStepNumber Int              @default(0)
  nextSendAt        DateTime
  lastSentAt        DateTime?
  exitReason        ExitReason?
  idempotencyKey    String? // Unique per (campaign, lead)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  workspace Workspace  @relation(fields: [workspaceId], references: [id])
  campaign  Campaign   @relation(fields: [campaignId], references: [id])
  lead      Lead       @relation(fields: [leadId], references: [id])
  jobs      EmailJob[]

  @@unique([campaignId, leadId])
  @@index([workspaceId])
  @@index([campaignId])
  @@index([leadId])
  @@index([nextSendAt])
}

// --- A5: Sending Infrastructure ---

enum ProviderType {
  Resend
  SES
  SendGrid
  SMTP
  Other
}

enum VerificationStatus {
  Unknown
  Pending
  Verified
  Failed
}

model SendingDomain {
  id          String             @id @default(cuid())
  workspaceId String
  domain      String             @unique
  subdomain   String?
  provider    ProviderType       @default(Resend)
  dkimStatus  VerificationStatus @default(Unknown)
  spfStatus   VerificationStatus @default(Unknown)
  dmarcStatus VerificationStatus @default(Unknown)
  isActive    Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  workspace Workspace        @relation(fields: [workspaceId], references: [id])
  mailboxes SendingMailbox[]
}

enum WarmupState {
  Cold
  Warming
  Warmed
  Restricted
}

model SendingMailbox {
  id              String  @id @default(cuid())
  workspaceId     String
  sendingDomainId String
  fromName        String
  fromEmail       String
  replyToEmail    String?
  isActive        Boolean @default(true)

  dailyCap        Int         @default(50)
  minDelaySeconds Int         @default(90)
  maxDelaySeconds Int         @default(240)
  warmupState     WarmupState @default(Cold)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace Workspace     @relation(fields: [workspaceId], references: [id])
  domain    SendingDomain @relation(fields: [sendingDomainId], references: [id])

  // Relations to Profiles via explicit junction or implied? 
  // User asked for "mailbox_ids uuid[] or junction". 
  // Prisma works best with implicit or explicit many-to-many.
  profiles SendingProfileMailbox[]
  jobs     EmailJob[]
}

enum RoutingStrategy {
  Single
  RoundRobin
  WeightedRoundRobin
}

model SendingProfile {
  id          String          @id @default(cuid())
  workspaceId String
  name        String
  strategy    RoutingStrategy @default(RoundRobin)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  workspace Workspace               @relation(fields: [workspaceId], references: [id])
  mailboxes SendingProfileMailbox[]
  campaigns Campaign[]
}

model SendingProfileMailbox {
  sendingProfileId String
  mailboxId        String
  weight           Int    @default(1)

  profile SendingProfile @relation(fields: [sendingProfileId], references: [id])
  mailbox SendingMailbox @relation(fields: [mailboxId], references: [id])

  @@id([sendingProfileId, mailboxId])
}

// --- A6: Email Jobs (Outbox) ---

enum JobStatus {
  Queued
  Sending
  Sent
  Failed
  Canceled
  Suppressed
}

model EmailJob {
  id           String  @id @default(cuid())
  workspaceId  String
  campaignId   String?
  enrollmentId String?
  leadId       String
  mailboxId    String
  templateId   String?

  toEmail          String
  subjectRendered  String
  bodyHtmlRendered String
  bodyTextRendered String?
  mergeVars        Json?

  status         JobStatus @default(Queued)
  scheduledAt    DateTime
  lockedAt       DateTime?
  lockedBy       String?
  attemptCount   Int       @default(0)
  nextAttemptAt  DateTime?
  lastError      String?
  idempotencyKey String?   @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workspace  Workspace           @relation(fields: [workspaceId], references: [id])
  campaign   Campaign?           @relation(fields: [campaignId], references: [id])
  enrollment CampaignEnrollment? @relation(fields: [enrollmentId], references: [id])
  lead       Lead                @relation(fields: [leadId], references: [id])
  mailbox    SendingMailbox      @relation(fields: [mailboxId], references: [id])
  template   EmailTemplate?      @relation(fields: [templateId], references: [id])

  message EmailMessage?
}

enum MessageStatus {
  Sent
  Delivered
  Bounced
  Complained
  Deferred
  Dropped
}

model EmailMessage {
  id                String        @id @default(cuid())
  workspaceId       String
  emailJobId        String        @unique
  providerMessageId String?
  provider          ProviderType
  fromEmail         String
  toEmail           String
  status            MessageStatus @default(Sent)
  sentAt            DateTime?
  deliveredAt       DateTime?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  workspace Workspace    @relation(fields: [workspaceId], references: [id])
  job       EmailJob     @relation(fields: [emailJobId], references: [id])
  events    EmailEvent[]
}

// --- A9: Pipeline Stages ---
model PipelineStage {
  id          String   @id @default(cuid())
  workspaceId String
  name        String
  orderIndex  Int
  isTerminal  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  workspace Workspace @relation(fields: [workspaceId], references: [id])
  leads     Lead[]
}

// --- B1: Event Outbox ---

enum EventStatus {
  Pending
  Processing
  Processed
  Failed
}

model EventOutbox {
  id            String      @id @default(cuid())
  workspaceId   String?
  eventType     String
  aggregateType String
  aggregateId   String
  payload       Json
  metadata      Json?
  status        EventStatus @default(Pending)
  attemptCount  Int         @default(0)
  nextAttemptAt DateTime?
  processedAt   DateTime?
  lastError     String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt // Used as locking mechanism sometimes

  @@index([status, nextAttemptAt])
}

// -----------------------------------------------------------------------------
// OUTREACH & CAMPAIGN MODELS
// -----------------------------------------------------------------------------

// -----------------------------------------------------------------------------
// CAMPAIGN MODELS (Refactored for v1.0)
// -----------------------------------------------------------------------------

enum CampaignStatus {
  Draft
  Running
  Paused
  Completed
  Stopped
  Archived
}

// CampaignType enum removed or kept? User schema didn't specify types, but useful. Keeping for now.
enum CampaignType {
  Outbound
  Nurture
  Onboarding
  Webinar
  Other
}

model Campaign {
  id               String         @id @default(cuid())
  workspaceId      String?
  name             String
  status           CampaignStatus @default(Draft)
  goal             String?
  type             CampaignType   @default(Outbound)
  targetFilters    Json?
  sendingProfileId String?
  schedule         Json?
  dailyCap         Int?
  createdByUserId  String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  workspace      Workspace?           @relation(fields: [workspaceId], references: [id])
  sendingProfile SendingProfile?      @relation(fields: [sendingProfileId], references: [id])
  steps          CampaignStep[]
  enrollments    CampaignEnrollment[]
  jobs           EmailJob[]
  leads          CampaignLead[]
  outreachEvents OutreachEvent[]
}

model CampaignStep {
  id            String  @id @default(cuid())
  campaignId    String
  order         Int
  templateId    String?
  delayHours    Int     @default(24)
  exitOnReply   Boolean @default(true)
  exitOnBooking Boolean @default(true)

  // Legacy fields (deprecating)
  subject      String?
  body         String?
  delayMinutes Int     @default(0)

  campaign       Campaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  template       EmailTemplate?  @relation(fields: [templateId], references: [id])
  outreachEvents OutreachEvent[]
}

model CampaignLead {
  id          String    @id @default(cuid())
  campaignId  String
  leadId      String
  currentStep Int       @default(1)
  status      String    @default("ACTIVE")
  nextSendAt  DateTime?
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  lead     Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@unique([campaignId, leadId])
}

enum OutreachEventType {
  Sent
  Delivered
  Opened
  Clicked
  Replied
  Bounced
  Complained
  Unsubscribed
}

model OutreachEvent {
  id         String            @id @default(cuid())
  type       OutreachEventType
  campaignId String?
  stepId     String?
  leadId     String
  userEmail  String?
  metadata   Json?
  occurredAt DateTime          @default(now())

  campaign Campaign?     @relation(fields: [campaignId], references: [id])
  step     CampaignStep? @relation(fields: [stepId], references: [id])
  lead     Lead          @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

// -----------------------------------------------------------------------------
// ANALYTICS MODELS (PROMPT 6)
// -----------------------------------------------------------------------------

enum AnalyticsEventType {
  // Quote Funnel
  QUOTE_MODAL_OPENED
  QUOTE_STEP_VIEWED
  QUOTE_STEP_COMPLETED
  QUOTE_VALIDATION_ERROR
  QUOTE_ABANDONED
  QUOTE_SUBMITTED

  // Account Conversion
  ACCOUNT_PROMPT_SHOWN
  ACCOUNT_CREATED_FROM_QUOTE
  ACCOUNT_SKIPPED
  ACCOUNT_INVITE_CLICKED

  // Lead -> Request
  LEAD_CREATED
  LEAD_CONVERTED_TO_REQUEST
  LEAD_ASSIGNED
  LEAD_STAGE_CHANGED

  // Request Lifecycle
  REQUEST_STAGE_CHANGED
  REQUEST_COMPLETED

  // Documents
  DOCUMENT_UPLOAD_STARTED
  DOCUMENT_UPLOAD_SUCCEEDED
  DOCUMENT_UPLOAD_FAILED

  // Other
  PAGE_VIEW
  CTA_CLICKED
}

model AnalyticsEvent {
  id            String             @id @default(cuid())
  createdAt     DateTime           @default(now())
  
  // Identity
  sessionId     String             // Anonymous session ID (hashed/cookie)
  userId        String?            // If authenticated
  leadId        String?            // If linked to a lead
  requestId     String?            // If linked to a request
  
  // Event Details
  eventType     AnalyticsEventType
  pagePath      String
  referrer      String?
  
  // Attribution
  utmSource     String?
  utmMedium     String?
  utmCampaign   String?
  
  // Context
  serviceSlug   String?
  categorySlug  String?
  locationSlug  String?
  stepIndex     Int?
  
  // Metadata
  metadata      Json?              // Flexible for errors, field names, etc.

  // Relations (Optional but helpful for data integrity if we want foreign keys)
  // For high-volume analytics, sticking to loose linking (just IDs) is often faster/safer
  // but for this CRM scale, FKs are fine and useful.
  user          User?              @relation(fields: [userId], references: [id])
  lead          Lead?              @relation(fields: [leadId], references: [id])
  request       ServiceRequest?    @relation(fields: [requestId], references: [id])
}
