generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// -----------------------------------------------------------------------------
// AUTH & USER MODELS
// -----------------------------------------------------------------------------

enum UserRole {
  ADMIN
  ACCOUNTANT
  STAFF
  EMPLOYEE
  CLIENT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String    @id @default(cuid())
  firstName     String?
  lastName      String?
  name          String?
  email         String?   @unique
  password      String?
  emailVerified DateTime?
  image         String?
  role          UserRole   @default(STAFF)
  status        UserStatus @default(ACTIVE)
  companyId     String?
  company       ClientCompany? @relation(fields: [companyId], references: [id])
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  accounts      Account[]
  sessions      Session[]
  
  // CRM Relations
  assignedRequests ServiceRequest[] @relation("AssignedTo")
  assignedTasks    Task[]           @relation("AssignedTo")
  uploadedDocs     Document[]
  activities       ActivityLog[]
  notifications    Notification[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// -----------------------------------------------------------------------------
// CRM MODELS
// -----------------------------------------------------------------------------

model ClientCompany {
  id                 String   @id @default(cuid())
  legalName          String
  tradingName        String?
  registrationNumber String?  @unique // CIPC
  vatNumber          String?
  payeNumber         String?
  uifNumber          String?
  sdlNumber          String?
  industry           String?
  address            String?
  city               String?
  province           String?
  country            String   @default("ZA")
  primaryContactId   String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  contacts        ClientContact[]
  serviceRequests ServiceRequest[]
  documents       Document[]
  activities      ActivityLog[]
  xeroConnection  XeroConnection?
  emailEvents     EmailEvent[]
  users           User[]
}

model ClientContact {
  id        String   @id @default(cuid())
  companyId String
  fullName  String
  email     String
  phone     String?
  roleTitle String?
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company ClientCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
}

enum ServiceType {
  Bookkeeping
  Accounting
  Tax
  Advisory
  CIPC
  CompaniesAct
  Payroll
  AuditReadiness
  TenderReadiness
  DataAnalytics
  BusinessIT
}

enum RequestStatus {
  New
  Contacted
  Qualified
  AwaitingDocs
  InProgress
  Submitted
  Completed
  OnHold
  Lost
}

enum Priority {
  Low
  Med
  High
}

model ServiceRequest {
  id               String        @id @default(cuid())
  companyId        String
  serviceType      ServiceType
  status           RequestStatus @default(New)
  priority         Priority      @default(Med)
  description      String?       @db.Text
  startDate        DateTime?
  dueDate          DateTime?
  assignedToUserId String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  company    ClientCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)
  assignedTo User?          @relation("AssignedTo", fields: [assignedToUserId], references: [id])
  tasks      Task[]
  documents  Document[]
  activities ActivityLog[]
  emailEvents EmailEvent[]
}

enum TaskStatus {
  Open
  Done
}

enum TaskType {
  FollowUp
  DocumentRequest
  Deadline
  InternalReview
}

model Task {
  id               String     @id @default(cuid())
  serviceRequestId String
  title            String
  description      String?    @db.Text
  status           TaskStatus @default(Open)
  dueDate          DateTime?
  assignedToUserId String?
  type             TaskType   @default(InternalReview)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  serviceRequest ServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  assignedTo     User?           @relation("AssignedTo", fields: [assignedToUserId], references: [id])
}

enum DocType {
  ID
  BankStatement
  Invoice
  CIPC
  SARS
  TenderDoc
  Other
}

enum AccessLevel {
  InternalOnly
  ClientVisible
}

model Document {
  id               String      @id @default(cuid())
  companyId        String
  serviceRequestId String?
  type             DocType     @default(Other)
  filename         String
  storageKey       String
  mimeType         String?
  size             Int?
  uploadedByUserId String
  uploadedAt       DateTime    @default(now())
  accessLevel      AccessLevel @default(InternalOnly)

  company        ClientCompany   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
  uploadedBy     User            @relation(fields: [uploadedByUserId], references: [id])
}

model ActivityLog {
  id               String   @id @default(cuid())
  actorUserId      String
  companyId        String?
  serviceRequestId String?
  actionType       String
  actionSummary    String
  metadata         Json?
  createdAt        DateTime @default(now())

  actor          User            @relation(fields: [actorUserId], references: [id])
  company        ClientCompany?  @relation(fields: [companyId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [serviceRequestId], references: [id])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ALERT
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  title     String
  message   String
  type      NotificationType @default(INFO)
  isRead    Boolean          @default(false)
  link      String?
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum EmailType {
  LeadReceived
  ClientConfirmation
  DocsRequested
  Reminder
  StatusUpdate
}

model EmailEvent {
  id                        String    @id @default(cuid())
  type                      EmailType
  to                        String
  subject                   String
  status                    String    // Sent, Failed, etc.
  providerMessageId         String?
  relatedCompanyId          String?
  relatedServiceRequestId   String?
  createdAt                 DateTime  @default(now())

  company        ClientCompany?  @relation(fields: [relatedCompanyId], references: [id])
  serviceRequest ServiceRequest? @relation(fields: [relatedServiceRequestId], references: [id])
}

// -----------------------------------------------------------------------------
// LEADS MODELS
// -----------------------------------------------------------------------------

enum LeadSource {
  Website
  Manual
  WhatsApp
  Referral
  EmailImport
}

enum LeadLocation {
  Johannesburg
  Sandton
  Pretoria
  Other
}

enum LeadUrgency {
  Urgent_24_48h
  Soon_7d
  Flexible_30d
}

enum LeadBudgetRange {
  Unknown
  Under5k
  R5k_15k
  R15k_30k
  R30kPlus
}

enum LeadStatus {
  Incomplete
  New
  Contacted
  Qualified
  AwaitingDocs
  Converted
  Lost
  Spam
}

model Lead {
  id                 String          @id @default(cuid())
  firstName          String
  lastName           String
  fullName           String?         // Deprecated
  email              String
  phone              String
  companyName        String?
  websiteUrl         String?
  source             LeadSource      @default(Website)
  serviceType        ServiceType
  location           LeadLocation    @default(Other)
  freeTextLocation   String?
  urgency            LeadUrgency     @default(Soon_7d)
  budgetRange        LeadBudgetRange @default(Unknown)
  message            String?         @db.Text
  status             LeadStatus      @default(New)
  leadScore          Int             @default(0)
  priorityTag        Priority        @default(Med)
  assignedToUserId   String?
  lastContactedAt    DateTime?
  nextFollowUpAt     DateTime?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  
  // Onboarding Tracking
  lastStepCompleted  Int             @default(0)
  abandonedAt        DateTime?
  resumeToken        String?         @unique
  deviceMetadata     Json?

  documents          LeadDocument[]
  statusEvents       LeadStatusEvent[]
  portalTokens       LeadPortalToken[]
}

enum LeadDocType {
  ID
  BankStatement
  ProofOfAddress
  CompanyDocs
  TaxDocs
  Other
}

enum LeadDocumentUploadedBy {
  Client
  Staff
}

model LeadDocument {
  id         String                 @id @default(cuid())
  leadId     String
  filename   String
  storageKey String
  mimeType   String?
  size       Int?
  type       LeadDocType            @default(Other)
  uploadedBy LeadDocumentUploadedBy @default(Client)
  uploadedAt DateTime               @default(now())
  note       String?                @db.Text

  lead       Lead                   @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model LeadStatusEvent {
  id          String     @id @default(cuid())
  leadId      String
  oldStatus   LeadStatus
  newStatus   LeadStatus
  actorUserId String?
  createdAt   DateTime   @default(now())

  lead        Lead       @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model LeadPortalToken {
  id         String   @id @default(cuid())
  leadId     String
  tokenHash  String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  lead       Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
}

model Invite {
  id        String   @id @default(cuid())
  email     String   @unique
  token     String   @unique
  role      UserRole
  status    String   @default("PENDING") // PENDING, ACCEPTED, EXPIRED
  expires   DateTime
  invitedBy String?
  createdAt DateTime @default(now())
}


// -----------------------------------------------------------------------------
// XERO INTEGRATION MODELS
// -----------------------------------------------------------------------------

enum XeroConnectionStatus {
  Connected
  Revoked
  Error
}

model XeroConnection {
  id           String               @id @default(cuid())
  companyId    String               @unique
  tenantId     String
  accessToken  String               @db.Text // Encrypted
  refreshToken String               @db.Text // Encrypted
  expiresAt    DateTime
  scopes       String?
  status       XeroConnectionStatus @default(Connected)
  lastSyncAt   DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt

  company     ClientCompany    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  syncCursors XeroSyncCursor[]
}

model XeroSyncCursor {
  id               String   @id @default(cuid())
  xeroConnectionId String
  resourceType     String   // Contacts, Invoices, Payments, BankTransactions
  lastSyncedAt     DateTime @default(now())
  lastCursor       String?

  connection XeroConnection @relation(fields: [xeroConnectionId], references: [id], onDelete: Cascade)
}

model EmailTemplate {
  id            String   @id @default(cuid())
  key           String   @unique
  subject       String?
  preheader     String?
  body          Json?    // Stores structured content or overrides
  lastEditedBy  String?  // User ID or name
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
